<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ficha de Manutenção</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#22c55e">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;margin:10px;background:#f0f0f0}
.card{background:#fff;padding:12px;border-radius:8px;margin-bottom:10px}
input,select,button,textarea{width:100%;padding:8px;margin-top:5px}
button{background:#22c55e;border:none;font-weight:bold}
img{width:70px;border-radius:6px;margin:5px}
</style>
</head>

<body>

<img src="logo.png" style="max-width:120px;display:block;margin:auto">
<h2 style="text-align:center">FICHA DE MANUTENÇÃO</h2>

<div class="card">
<input id="placa" placeholder="Placa">
<input id="motorista" placeholder="Motorista">

<label>Mecânico</label>
<select id="mecanico" multiple>
  <option>FAGNER</option>
  <option>WESLEY</option>
</select>

<textarea id="observacao" placeholder="Observações / Serviços sem peça"></textarea>
</div>

<div class="card">
<h3>Adicionar Peça</h3>
<input id="peca" placeholder="Nome da peça">
<input id="qtd" placeholder="Quantidade">
<input id="preco" type="number" step="0.01" placeholder="Preço (opcional)">
<input id="foto" type="file" accept="image/*">

<button onclick="addPeca()">Adicionar Peça</button>
<div id="listaPecas"></div>
</div>

<button onclick="gerarPDF()">Gerar PDF</button>
<button onclick="salvarFicha()">Salvar Ficha</button>
<a href="admin.html"><button>Painel Admin</button></a>

<script>
let pecas=[];

function addPeca(){
 const nome=peca.value,q=qtd.value,p=preco.value,f=foto.files[0];
 if(!nome||!q)return alert("Peça e quantidade obrigatórias");

 const reader=new FileReader();
 reader.onload=()=>{ 
  pecas.push({nome:q?nome:nome,qtd:q,preco:p?parseFloat(p):0,foto:reader.result});
  listaPecas.innerHTML+=`<p>${nome} (${q}) R$ ${p||"0,00"}</p>`;
 };
 if(f) reader.readAsDataURL(f); else reader.onload();
 peca.value=qtd.value=preco.value=foto.value="";
}

function salvarFicha(){
 const ficha={
  data:new Date().toISOString(),
  placa:placa.value,
  motorista:motorista.value,
  mecanico:Array.from(mecanico.selectedOptions).map(o=>o.value).join(", "),
  observacao:observacao.value,
  pecas
 };
 let fichas=JSON.parse(localStorage.getItem("fichas"))||[];
 fichas.push(ficha);
 localStorage.setItem("fichas",JSON.stringify(fichas));
 alert("Ficha salva!");
 location.reload();
}

function gerarPDF(){
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();
 let y=20;
 doc.text("FICHA DE MANUTENÇÃO",105,y,{align:"center"});
 y+=10;
 doc.text(`Placa: ${placa.value}`,20,y);y+=7;
 doc.text(`Motorista: ${motorista.value}`,20,y);y+=7;
 doc.text(`Mecânico: ${Array.from(mecanico.selectedOptions).map(o=>o.value)}`,20,y);y+=10;
 pecas.forEach((p,i)=>{
  doc.text(`${i+1} - ${p.nome} (${p.qtd}) R$ ${p.preco}`,20,y);
  y+=7;
 });
 doc.save("ficha.pdf");
}

if("serviceWorker" in navigator){
 navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
